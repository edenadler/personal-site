{"version":3,"sources":["../../../src/bootstrap/load-plugins/load.js"],"names":["_","require","slash","fs","path","crypto","glob","store","existsSync","sync","createNodeId","createFileContentHash","root","globPattern","hash","createHash","files","nodir","forEach","filepath","update","readFileSync","digest","resolvePlugin","pluginName","resolvedPath","resolve","packageJSON","JSON","parse","name","id","version","Error","dirname","err","module","exports","config","plugins","processPlugin","plugin","isString","info","pluginOptions","subplugins","options","p","push","stringify","merge","internalPlugins","relPath","absPath","join","__dirname","process","cwd","program","getState","directory","pathCheck"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst slash = require(`slash`)\nconst fs = require(`fs`)\nconst path = require(`path`)\nconst crypto = require(`crypto`)\nconst glob = require(`glob`)\nconst { store } = require(`../../redux`)\nconst existsSync = require(`fs-exists-cached`).sync\nconst createNodeId = require(`../../utils/create-node-id`)\n\nfunction createFileContentHash(root, globPattern) {\n  const hash = crypto.createHash(`md5`)\n  const files = glob.sync(`${root}/${globPattern}`, { nodir: true })\n\n  files.forEach(filepath => {\n    hash.update(fs.readFileSync(filepath))\n  })\n\n  return hash.digest(`hex`)\n}\n\n/**\n * @typedef {Object} PluginInfo\n * @property {string} resolve The absolute path to the plugin\n * @property {string} name The plugin name\n * @property {string} version The plugin version (can be content hash)\n */\n\n/**\n * resolvePlugin\n * @param {string} pluginName\n * This can be a name of a local plugin, the name of a plugin located in\n * node_modules, or a Gatsby internal plugin. In the last case the pluginName\n * will be an absolute path.\n * @return {PluginInfo}\n */\nfunction resolvePlugin(pluginName) {\n  // Only find plugins when we're not given an absolute path\n  if (!existsSync(pluginName)) {\n    // Find the plugin in the local plugins folder\n    const resolvedPath = slash(path.resolve(`./plugins/${pluginName}`))\n\n    if (existsSync(resolvedPath)) {\n      if (existsSync(`${resolvedPath}/package.json`)) {\n        const packageJSON = JSON.parse(\n          fs.readFileSync(`${resolvedPath}/package.json`, `utf-8`)\n        )\n\n        return {\n          resolve: resolvedPath,\n          name: packageJSON.name || pluginName,\n          id: createNodeId(packageJSON.name, `Plugin`),\n          version:\n            packageJSON.version || createFileContentHash(resolvedPath, `**`),\n        }\n      } else {\n        // Make package.json a requirement for local plugins too\n        throw new Error(`Plugin ${pluginName} requires a package.json file`)\n      }\n    }\n  }\n\n  /**\n   * Here we have an absolute path to an internal plugin, or a name of a module\n   * which should be located in node_modules.\n   */\n  try {\n    const resolvedPath = slash(path.dirname(require.resolve(pluginName)))\n\n    const packageJSON = JSON.parse(\n      fs.readFileSync(`${resolvedPath}/package.json`, `utf-8`)\n    )\n\n    return {\n      resolve: resolvedPath,\n      id: createNodeId(packageJSON.name, `Plugin`),\n      name: packageJSON.name,\n      version: packageJSON.version,\n    }\n  } catch (err) {\n    throw new Error(\n      `Unable to find plugin \"${pluginName}\". Perhaps you need to install its package?`\n    )\n  }\n}\n\nmodule.exports = (config = {}) => {\n  // Instantiate plugins.\n  const plugins = []\n\n  // Create fake little site with a plugin for testing this\n  // w/ snapshots. Move plugin processing to its own module.\n  // Also test adding to redux store.\n  const processPlugin = plugin => {\n    if (_.isString(plugin)) {\n      const info = resolvePlugin(plugin)\n\n      return {\n        ...info,\n        pluginOptions: {\n          plugins: [],\n        },\n      }\n    } else {\n      // Plugins can have plugins.\n      const subplugins = []\n      if (plugin.options && plugin.options.plugins) {\n        plugin.options.plugins.forEach(p => {\n          subplugins.push(processPlugin(p))\n        })\n\n        plugin.options.plugins = subplugins\n      }\n\n      // Add some default values for tests as we don't actually\n      // want to try to load anything during tests.\n      if (plugin.resolve === `___TEST___`) {\n        return {\n          name: `TEST`,\n          pluginOptions: {\n            plugins: [],\n          },\n        }\n      }\n\n      const info = resolvePlugin(plugin.resolve)\n\n      return {\n        ...info,\n        // Make sure key is unique to plugin options. E.g there could\n        // be multiple source-filesystem plugins, with different names\n        // (docs, blogs).\n        id: createNodeId(\n          plugin.options\n            ? plugin.name + JSON.stringify(plugin.options)\n            : plugin.name,\n          `Plugin`\n        ),\n        pluginOptions: _.merge({ plugins: [] }, plugin.options),\n      }\n    }\n  }\n\n  // Add internal plugins\n  const internalPlugins = [\n    `../../internal-plugins/dev-404-page`,\n    `../../internal-plugins/load-babel-config`,\n    `../../internal-plugins/internal-data-bridge`,\n    `../../internal-plugins/prod-404`,\n    `../../internal-plugins/query-runner`,\n  ]\n  internalPlugins.forEach(relPath => {\n    const absPath = path.join(__dirname, relPath)\n    plugins.push(processPlugin(absPath))\n  })\n\n  // Add plugins from the site config.\n  if (config.plugins) {\n    config.plugins.forEach(plugin => {\n      plugins.push(processPlugin(plugin))\n    })\n  }\n\n  // Add the site's default \"plugin\" i.e. gatsby-x files in root of site.\n  plugins.push({\n    resolve: slash(process.cwd()),\n    id: createNodeId(`default-site-plugin`, `Plugin`),\n    name: `default-site-plugin`,\n    version: createFileContentHash(process.cwd(), `gatsby-*`),\n    pluginOptions: {\n      plugins: [],\n    },\n  })\n\n  const program = store.getState().program\n  plugins.push(\n    processPlugin({\n      resolve: `gatsby-plugin-page-creator`,\n      options: {\n        path: slash(path.join(program.directory, `src/pages`)),\n        pathCheck: false,\n      },\n    })\n  )\n\n  return plugins\n}\n"],"file":"load.js"}